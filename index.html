<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø±ØµØ¯ ÙƒØªØ¨ ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f5f5f5;--card:#fff;--text:#1a1a1a;--text2:#666;
  --red:#c8102e;--green:#007a3d;--black:#000;
  --ar:#007a3d;--fr:#2563eb;--en:#7c3aed;
  --shadow:0 2px 24px rgba(0,0,0,.08);--radius:18px
}
body{font-family:'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.65;min-height:100vh}

.hero{background:linear-gradient(135deg,var(--black) 0%,var(--red) 50%,var(--green) 100%);color:#fff;padding:50px 20px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,var(--black) 0%,var(--black) 33%,#fff 33%,#fff 50%,var(--green) 50%,var(--green) 100%);opacity:.08;pointer-events:none}
.hero-c{position:relative;z-index:2}
.hero h1{font-size:2.5em;font-weight:900;margin-bottom:12px;text-shadow:2px 2px 8px rgba(0,0,0,.3)}
.hero .sub{font-size:1.2em;opacity:.95;margin-bottom:20px;font-weight:500}
.hero .info{font-size:.95em;opacity:.9;max-width:800px;margin:0 auto}
.badges{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:20px}
.badges span{padding:8px 20px;border-radius:50px;font-size:.9em;font-weight:700;border:2px solid rgba(255,255,255,.3);background:rgba(255,255,255,.15);backdrop-filter:blur(8px)}

.stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;max-width:1400px;margin:-35px auto 30px;padding:0 20px;position:relative;z-index:10}
.stat-card{background:var(--card);border-radius:var(--radius);padding:22px 16px;text-align:center;box-shadow:var(--shadow);border-top:4px solid var(--red);transition:transform .3s}
.stat-card:hover{transform:translateY(-4px)}
.stat-card .icon{font-size:2em;margin-bottom:6px}
.stat-card .num{font-size:2em;font-weight:900;color:var(--red);line-height:1}
.stat-card .lbl{font-size:.85em;color:var(--text2);margin-top:6px;font-weight:600}

.controls{max-width:1400px;margin:0 auto 28px;padding:0 20px}
.search-row{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.search-box{flex:1;min-width:280px;padding:14px 24px;border-radius:50px;border:2px solid #e0e0e0;font-size:1.05em;outline:none;transition:all .3s;background:#fff;direction:rtl}
.search-box:focus{border-color:var(--red);box-shadow:0 0 0 4px rgba(200,16,46,.1)}
.filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.filter-label{font-size:.95em;font-weight:700;color:var(--text);margin-left:8px}
.fbtn{padding:10px 24px;border-radius:50px;border:2px solid #e0e0e0;background:#fff;cursor:pointer;font-size:.95em;font-weight:700;transition:all .3s;color:var(--text)}
.fbtn:hover{border-color:var(--red);color:var(--red)}
.fbtn.active{background:var(--red);color:#fff;border-color:var(--red)}
.fbtn.a-ar{background:var(--ar);color:#fff;border-color:var(--ar)}
.fbtn.a-fr{background:var(--fr);color:#fff;border-color:var(--fr)}
.fbtn.a-en{background:var(--en);color:#fff;border-color:var(--en)}
.sel{padding:10px 20px;border-radius:50px;border:2px solid #e0e0e0;background:#fff;font-size:.95em;font-weight:600;cursor:pointer;outline:none}
.sel:focus{border-color:var(--red)}

.update-bar{max-width:1400px;margin:0 auto 20px;padding:0 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.live{display:flex;align-items:center;gap:8px;font-size:.9em;color:var(--green);font-weight:700}
.live-dot{width:10px;height:10px;background:var(--green);border-radius:50%;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.85)}}
.time{font-size:.85em;color:var(--text2)}
.rbtn{padding:10px 24px;border-radius:50px;border:none;background:var(--red);color:#fff;cursor:pointer;font-size:.9em;font-weight:700;transition:all .3s;box-shadow:0 2px 8px rgba(200,16,46,.2)}
.rbtn:hover{background:#a00c24}
.rbtn:disabled{opacity:.5;cursor:not-allowed}

.pbar{max-width:1400px;margin:0 auto 16px;padding:0 20px;display:none}
.ptrack{height:6px;background:#e0e0e0;border-radius:6px;overflow:hidden}
.pfill{height:100%;background:linear-gradient(90deg,var(--red),var(--green));border-radius:6px;transition:width .5s;width:0}
.ptxt{font-size:.8em;color:var(--text2);margin-top:6px;text-align:center;font-weight:600}

/* â”€â”€ debug log â”€â”€ */
.debug-panel{max-width:1400px;margin:0 auto 20px;padding:0 20px;display:none}
.debug-panel.show{display:block}
.debug-log{background:#1a1a1a;color:#0f0;padding:16px;border-radius:12px;font-family:'Courier New',monospace;font-size:.8em;max-height:300px;overflow-y:auto;direction:ltr;text-align:left;line-height:1.8}
.debug-toggle{padding:8px 20px;border-radius:50px;border:2px solid #e0e0e0;background:#fff;cursor:pointer;font-size:.85em;font-weight:600;margin-bottom:10px}

.books-grid{max-width:1400px;margin:0 auto;padding:0 20px 50px;display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:24px}

.book-card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);border-top:4px solid var(--red);transition:transform .3s,box-shadow .3s;display:flex;flex-direction:column}
.book-card:hover{transform:translateY(-6px);box-shadow:0 12px 40px rgba(0,0,0,.15)}
.book-card.new-card{animation:glow 2s ease-out}
@keyframes glow{0%{box-shadow:0 0 0 4px var(--green)}100%{box-shadow:var(--shadow)}}

.cover-wrap{position:relative;height:240px;background:linear-gradient(135deg,#1a1a1a,#2c2c2c);display:flex;align-items:center;justify-content:center;overflow:hidden}
.cover-wrap::before{content:'';position:absolute;inset:0;background:linear-gradient(0deg,var(--black) 0%,transparent 40%),linear-gradient(180deg,var(--green) 0%,transparent 40%);opacity:.2}
.cover-wrap img{height:200px;max-width:150px;object-fit:cover;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.5);transition:transform .4s;position:relative;z-index:2}
.book-card:hover .cover-wrap img{transform:scale(1.05)}
.lang-badge{position:absolute;top:14px;right:14px;padding:6px 16px;border-radius:30px;font-size:.8em;font-weight:800;color:#fff;z-index:3;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.l-ar{background:var(--ar)}.l-fr{background:var(--fr)}.l-en{background:var(--en)}
.src-badge{position:absolute;bottom:12px;left:12px;padding:4px 12px;border-radius:12px;font-size:.7em;background:rgba(255,255,255,.2);color:rgba(255,255,255,.9);backdrop-filter:blur(6px);font-weight:700;z-index:3}

.book-body{padding:20px;flex:1;display:flex;flex-direction:column}
.book-title{font-size:1.1em;font-weight:800;line-height:1.5;color:var(--text);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:10px}
.book-author{font-size:.95em;color:var(--red);font-weight:700;margin-bottom:6px}
.book-pub{font-size:.85em;color:var(--text2);margin-bottom:10px}
.book-meta{display:flex;flex-wrap:wrap;gap:14px;font-size:.8em;color:var(--text2);margin-bottom:12px}
.book-meta span{display:flex;align-items:center;gap:5px;font-weight:600}
.topics{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.tag{padding:4px 14px;border-radius:30px;font-size:.75em;background:#f0f9f4;color:var(--green);font-weight:700;border:1px solid #d1f0dd}
.tag.hot{background:#fef2f2;color:var(--red);border-color:#fecaca}
.book-desc{font-size:.88em;color:var(--text2);line-height:1.65;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:14px}
.book-actions{margin-top:auto;display:flex;gap:10px}
.blink{flex:1;padding:12px;text-align:center;border-radius:14px;font-size:.9em;font-weight:700;text-decoration:none;transition:all .3s}
.bp{background:var(--black);color:#fff}
.bp:hover{background:var(--red);transform:translateY(-2px)}
.bs{background:#f5f5f5;color:var(--text);border:2px solid #e0e0e0}
.bs:hover{background:#eee;border-color:var(--green)}

.loader{text-align:center;padding:80px;grid-column:1/-1}
.spinner{width:60px;height:60px;border:5px solid #e0e0e0;border-top-color:var(--red);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{font-size:1.1em;color:var(--text2);font-weight:600}
.no-res{text-align:center;padding:80px;grid-column:1/-1;color:var(--text2)}
.no-res .emoji{font-size:5em;margin-bottom:16px}

.notif{position:fixed;bottom:20px;right:20px;background:var(--green);color:#fff;padding:16px 24px;border-radius:14px;font-weight:700;font-size:.95em;box-shadow:0 8px 32px rgba(0,0,0,.3);z-index:1000;display:none;animation:slideUp .5s ease-out}
@keyframes slideUp{from{transform:translateY(100px);opacity:0}to{transform:translateY(0);opacity:1}}

footer{background:linear-gradient(135deg,var(--black),#2c2c2c);color:#fff;text-align:center;padding:40px 20px;margin-top:40px}
footer h3{font-size:1.5em;margin-bottom:12px;font-weight:800}
footer p{font-size:.95em;opacity:.85;margin-bottom:8px;line-height:1.8}

@media(max-width:768px){
  .hero h1{font-size:1.8em}
  .books-grid{grid-template-columns:1fr}
  .stats-bar{grid-template-columns:repeat(2,1fr)}
  .filter-row{justify-content:center}
}
</style>
</head>
<body>

<div class="hero">
  <div class="hero-c">
    <h1>ğŸ‡µğŸ‡¸ Ù…Ø±ØµØ¯ ÙƒØªØ¨ ÙÙ„Ø³Ø·ÙŠÙ†</h1>
    <p class="sub">Palestine Books Observatory</p>
    <p class="info">Ù…Ø±ØµØ¯ Ù…ØªØ®ØµØµ ÙŠØ¬Ù…Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø£Ø­Ø¯Ø« Ø§Ù„ÙƒØªØ¨ Ø­ÙˆÙ„ Ø§Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ© (2023-2026)<br>Ù…Ù† Ø¹Ø¯Ø© Ù…ØµØ§Ø¯Ø± Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© â€” Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ§Ù„ÙØ±Ù†Ø³ÙŠØ©</p>
    <div class="badges">
      <span>ğŸ“… 2023-2026</span>
      <span>ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙŠÙˆÙ…ÙŠ</span>
      <span>ğŸŒ 3 Ù„ØºØ§Øª</span>
    </div>
  </div>
</div>

<div class="stats-bar">
  <div class="stat-card"><div class="icon">ğŸ“š</div><div class="num" id="sTotal">-</div><div class="lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>
  <div class="stat-card"><div class="icon">ğŸ‡µğŸ‡¸</div><div class="num" id="sAr">-</div><div class="lbl">Ø¹Ø±Ø¨ÙŠ</div></div>
  <div class="stat-card"><div class="icon">ğŸ‡¬ğŸ‡§</div><div class="num" id="sEn">-</div><div class="lbl">English</div></div>
  <div class="stat-card"><div class="icon">ğŸ‡«ğŸ‡·</div><div class="num" id="sFr">-</div><div class="lbl">FranÃ§ais</div></div>
  <div class="stat-card"><div class="icon">ğŸ›</div><div class="num" id="sPub">-</div><div class="lbl">Ù†Ø§Ø´Ø±</div></div>
  <div class="stat-card"><div class="icon">ğŸ”</div><div class="num" id="sSrc">-</div><div class="lbl">Ù…ØµØ§Ø¯Ø± Ù†Ø´Ø·Ø©</div></div>
</div>

<div class="controls">
  <div class="search-row">
    <input type="text" class="search-box" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ØŒ Ù…Ø¤Ù„ÙØŒ Ø£Ùˆ Ù†Ø§Ø´Ø±..." oninput="filterBooks()">
  </div>
  <div class="filter-row">
    <span class="filter-label">Ø§Ù„Ù„ØºØ©:</span>
    <button class="fbtn active" onclick="setLang('all',this)">Ø§Ù„ÙƒÙ„</button>
    <button class="fbtn" onclick="setLang('ar',this)">ğŸ‡µğŸ‡¸ Ø¹Ø±Ø¨ÙŠ</button>
    <button class="fbtn" onclick="setLang('en',this)">ğŸ‡¬ğŸ‡§ English</button>
    <button class="fbtn" onclick="setLang('fr',this)">ğŸ‡«ğŸ‡· FranÃ§ais</button>
    <span class="filter-label" style="margin-right:20px">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</span>
    <select class="sel" id="topicSel" onchange="filterBooks()">
      <option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹</option>
      <option value="Gaza">ØºØ²Ø©</option>
      <option value="History">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
      <option value="Nakba">Ø§Ù„Ù†ÙƒØ¨Ø©</option>
      <option value="Genocide">Ø§Ù„Ø¥Ø¨Ø§Ø¯Ø©</option>
      <option value="Occupation">Ø§Ù„Ø§Ø­ØªÙ„Ø§Ù„</option>
      <option value="Resistance">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©</option>
      <option value="Jerusalem">Ø§Ù„Ù‚Ø¯Ø³</option>
      <option value="Refugees">Ø§Ù„Ù„Ø§Ø¬Ø¦ÙˆÙ†</option>
      <option value="International Law">Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¯ÙˆÙ„ÙŠ</option>
      <option value="Literature">Ø§Ù„Ø£Ø¯Ø¨</option>
    </select>
    <span class="filter-label" style="margin-right:20px">ØªØ±ØªÙŠØ¨:</span>
    <select class="sel" id="sortSel" onchange="filterBooks()">
      <option value="date">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
      <option value="title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</option>
    </select>
  </div>
</div>

<div class="update-bar">
  <div class="live"><span class="live-dot"></span><span>ØªØ­Ø¯ÙŠØ« ÙŠÙˆÙ…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span></div>
  <span class="time" id="lastUp">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
  <button class="rbtn" id="rBtn" onclick="manualRefresh()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
  <button class="debug-toggle" onclick="toggleDebug()">ğŸ› Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹</button>
</div>

<div class="pbar" id="pbar">
  <div class="ptrack"><div class="pfill" id="pfill"></div></div>
  <div class="ptxt" id="ptxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>
</div>

<div class="debug-panel" id="debugPanel">
  <div class="debug-log" id="debugLog"></div>
</div>

<div class="books-grid" id="grid">
  <div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨...</p></div>
</div>

<div class="notif" id="notif"></div>

<footer>
  <h3>ğŸ‡µğŸ‡¸ Ù…Ø±ØµØ¯ ÙƒØªØ¨ ÙÙ„Ø³Ø·ÙŠÙ†</h3>
  <p>ÙŠØ¬Ù…Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Google Books, Open Library, Crossref</p>
  <p style="font-size:.85em;margin-top:12px">Â© 2024 â€” Palestine Books Observatory</p>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù…Ø­Ø±Ùƒ Ù…Ø±ØµØ¯ ÙƒØªØ¨ ÙÙ„Ø³Ø·ÙŠÙ† ğŸ‡µğŸ‡¸ v6 (Ù…ÙØµØ­ÙÙ‘Ø­)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let ALL_BOOKS = [];
let currentLang = 'all';
let isUpdating = false;
let activeSources = new Set();
const DAILY_MS = 24 * 60 * 60 * 1000;
const CACHE_KEY = 'pbooks_v6';

// â”€â”€â”€ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ â”€â”€â”€
const debugLines = [];
function log(msg, type = 'info') {
  const time = new Date().toLocaleTimeString();
  const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warn' ? 'âš ï¸' : 'â„¹ï¸';
  const line = `[${time}] ${prefix} ${msg}`;
  debugLines.push(line);
  console.log(line);
  const el = document.getElementById('debugLog');
  if (el) {
    el.textContent = debugLines.slice(-100).join('\n');
    el.scrollTop = el.scrollHeight;
  }
}
function toggleDebug() {
  document.getElementById('debugPanel').classList.toggle('show');
}

// â”€â”€â”€ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ø­Ø« â”€â”€â”€
const QUERIES = {
  en: [
    "palestine","palestinian history","gaza war","gaza genocide",
    "nakba 1948","israeli occupation","palestinian resistance",
    "jerusalem al-quds","west bank settlements","palestinian refugees",
    "israel war crimes","apartheid israel","zionism colonialism",
    "BDS movement","intifada","october 7 hamas",
    "ethnic cleansing palestine","one state solution",
    "mahmoud darwish","edward said orientalism",
    "ilan pappe","norman finkelstein","noam chomsky palestine",
    "rashid khalidi","gaza blockade","ICJ palestine"
  ],
  fr: [
    "palestine","histoire palestinienne","gaza guerre",
    "nakba 1948","occupation israÃ©lienne","rÃ©sistance palestinienne",
    "jÃ©rusalem al-qods","rÃ©fugiÃ©s palestiniens","apartheid israÃ©lien",
    "sionisme colonialisme","mahmoud darwich","gÃ©nocide gaza",
    "crimes de guerre israÃ«l","droit international palestine"
  ],
  ar: [
    "ÙÙ„Ø³Ø·ÙŠÙ†","Ø§Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©","ØºØ²Ø© Ø­Ø±Ø¨","ØºØ²Ø© Ø¥Ø¨Ø§Ø¯Ø©",
    "Ø§Ù„Ù†ÙƒØ¨Ø© 1948","Ø§Ù„Ø§Ø­ØªÙ„Ø§Ù„ Ø§Ù„Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„ÙŠ","Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©",
    "Ø§Ù„Ù‚Ø¯Ø³","Ø§Ù„Ù„Ø§Ø¬Ø¦ÙˆÙ† Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠÙˆÙ†","Ø§Ù„Ø§Ø³ØªÙŠØ·Ø§Ù†","Ù…Ø­Ù…ÙˆØ¯ Ø¯Ø±ÙˆÙŠØ´",
    "ØºØ³Ø§Ù† ÙƒÙ†ÙØ§Ù†ÙŠ","Ø§Ù„ØªØ·Ù‡ÙŠØ± Ø§Ù„Ø¹Ø±Ù‚ÙŠ ÙÙ„Ø³Ø·ÙŠÙ†","Ø·ÙˆÙØ§Ù† Ø§Ù„Ø£Ù‚ØµÙ‰",
    "Ø¬Ø±Ø§Ø¦Ù… Ø§Ù„Ø­Ø±Ø¨ Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„","Ø­Ù‚ Ø§Ù„Ø¹ÙˆØ¯Ø©","Ø§Ù„Ø¶ÙØ© Ø§Ù„ØºØ±Ø¨ÙŠØ©",
    "Ø§Ù„ØµÙ‡ÙŠÙˆÙ†ÙŠØ©","Ø§Ù„Ø§Ù†ØªÙØ§Ø¶Ø©","Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠ"
  ]
};

// â”€â”€â”€ ÙƒØ´Ù Ø§Ù„Ù„ØºØ© â”€â”€â”€
function detectLang(text) {
  if (!text) return 'en';
  if (/[\u0600-\u06FF]/.test(text)) return 'ar';
  if (/[Ã Ã¢Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦]/i.test(text)) return 'fr';
  if (/\b(le|la|les|du|des|une?|et|ou|qui|que|dans|pour|avec|sur|par)\b/i.test(text)) return 'fr';
  return 'en';
}

// â”€â”€â”€ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª â”€â”€â”€
function detectTopics(title, desc) {
  const t = ((title||'') + ' ' + (desc||'')).toLowerCase();
  const out = [];
  const map = [
    [/ØºØ²|gaza/i, 'Gaza'],
    [/Ù†ÙƒØ¨|nakba|catastrophe/i, 'Nakba'],
    [/Ø¥Ø¨Ø§Ø¯|genocide|gÃ©nocide/i, 'Genocide'],
    [/Ø§Ø­ØªÙ„Ø§Ù„|occupation/i, 'Occupation'],
    [/Ù…Ù‚Ø§ÙˆÙ…|resistance|rÃ©sistance/i, 'Resistance'],
    [/ØªØ§Ø±ÙŠØ®|history|histoire/i, 'History'],
    [/Ù‚Ø¯Ø³|jerusalem|jÃ©rusalem/i, 'Jerusalem'],
    [/Ù„Ø§Ø¬|refugee|rÃ©fugiÃ©/i, 'Refugees'],
    [/Ù‚Ø§Ù†ÙˆÙ†.*Ø¯ÙˆÙ„|international.law|droit.inter/i, 'International Law'],
    [/Ø£Ø¯Ø¨|literature|littÃ©rature/i, 'Literature'],
    [/Ø­Ù‚ÙˆÙ‚|human.right|droits/i, 'Human Rights'],
    [/Ø£Ø¨Ø§Ø±ØªÙ‡Ø§ÙŠØ¯|apartheid/i, 'Apartheid'],
    [/ØµÙ‡ÙŠÙˆÙ†|zionism|sionisme/i, 'Zionism'],
    [/Ø§Ø³ØªÙŠØ·Ø§Ù†|settlement|coloni/i, 'Settlements'],
    [/Ø§Ù†ØªÙØ§Ø¶|intifada/i, 'Intifada'],
    [/ØªØ·Ù‡ÙŠØ±|ethnic.cleansing|nettoyage/i, 'Ethnic Cleansing'],
    [/Ø­Ù…Ø§Ø³|hamas/i, 'Hamas'],
    [/Ø­ØµØ§Ø±|blockade|blocus|siege/i, 'Blockade'],
    [/Ø¹ÙˆØ¯|return|retour/i, 'Right of Return'],
    [/Ø¶Ù|west.bank|cisjordanie/i, 'West Bank'],
  ];
  for (const [rx, label] of map) {
    if (rx.test(t)) out.push(label);
  }
  if (/palestin|ÙÙ„Ø³Ø·/i.test(t) && !out.includes('Palestine')) out.unshift('Palestine');
  return out.length ? out.slice(0,5) : ['Palestine'];
}

// â•â•â•â•â•â•â• Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± â•â•â•â•â•â•â•
function normT(s) {
  return (s||'').toLowerCase().replace(/[^\w\s\u0600-\u06FF]/g,' ').replace(/\s+/g,' ').trim().substring(0,80);
}
function dedup(books) {
  const seen = new Set();
  const titles = [];
  const out = [];
  for (const b of books) {
    const nt = normT(b.title);
    if (!nt || nt.length < 5) continue;

    // ISBN check
    const isbn = (b.isbn||'').replace(/[^0-9X]/gi,'');
    if (isbn.length >= 10) {
      if (seen.has('isbn:'+isbn)) continue;
      seen.add('isbn:'+isbn);
    }

    // Title similarity
    let dup = false;
    for (const et of titles) {
      if (nt === et || nt.includes(et) || et.includes(nt)) { dup = true; break; }
      // Jaccard
      const w1 = new Set(nt.split(' ').filter(w=>w.length>2));
      const w2 = new Set(et.split(' ').filter(w=>w.length>2));
      if (w1.size && w2.size) {
        const inter = [...w1].filter(x=>w2.has(x)).length;
        const union = new Set([...w1,...w2]).size;
        if (inter/union > 0.8) { dup = true; break; }
      }
    }
    if (dup) continue;

    titles.push(nt);
    out.push(b);
  }
  log(`Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±: ${books.length} â†’ ${out.length}`);
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Google Books API - Ù…ÙØµØ­ÙÙ‘Ø­
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchGoogle(query, langRestrict) {
  const books = [];
  try {
    const params = new URLSearchParams({
      q: query,
      printType: 'books',
      orderBy: 'newest',
      maxResults: '40',
    });
    // Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ù„ØºØ© ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„ÙØ±Ù†Ø³ÙŠØ©
    if (langRestrict === 'ar' || langRestrict === 'fr') {
      params.set('langRestrict', langRestrict);
    }

    const url = `https://www.googleapis.com/books/v1/volumes?${params}`;
    log(`Google Books: "${query}" (lang=${langRestrict||'any'})`);

    const resp = await fetch(url);

    if (resp.status === 429) {
      log('Google Books: Rate limit! Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 5 Ø«ÙˆØ§Ù†Ù...', 'warn');
      await sleep(5000);
      return books;
    }

    if (!resp.ok) {
      log(`Google Books: HTTP ${resp.status} for "${query}"`, 'error');
      return books;
    }

    const data = await resp.json();
    const items = data.items || [];
    log(`Google Books: "${query}" â†’ ${items.length} Ù†ØªÙŠØ¬Ø©`, items.length > 0 ? 'success' : 'warn');

    // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ù†Ø©: 2022 (Ù„Ù†ÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù…Ø±ÙˆÙ†Ø©)
    const minYear = 2022;

    for (const item of items) {
      try {
        const v = item.volumeInfo || {};
        const title = v.title || '';
        if (!title || title.length < 3) continue;

        // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø± - Ù…Ø±Ù† Ø£ÙƒØ«Ø±
        const pubDate = v.publishedDate || '';
        let year = 0;
        if (pubDate) {
          year = parseInt(pubDate.substring(0, 4));
        }

        // â˜… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ÙƒØªØ¨: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù‡Ø§ ØªØ§Ø±ÙŠØ® >= 2022ØŒ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® (Ù†Ù‚Ø¨Ù„Ù‡Ø§)
        if (year > 0 && year < minYear) continue;
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙ„ÙŠØ³ ÙÙŠÙ‡Ø§ ÙƒÙ„Ù…Ø© ÙÙ„Ø³Ø·ÙŠÙ†ØŒ Ù†ØªØ®Ø·Ø§Ù‡Ø§
        if (!year && !/palestin|ÙÙ„Ø³Ø·|gaza|ØºØ²|nakba|Ù†ÙƒØ¨/i.test(title + ' ' + (v.description||''))) continue;

        const lang = v.language === 'ar' ? 'ar' : v.language === 'fr' ? 'fr' : detectLang(title);
        const isbns = v.industryIdentifiers || [];
        const isbn13 = isbns.find(i => i.type === 'ISBN_13');
        const isbn10 = isbns.find(i => i.type === 'ISBN_10');

        const book = {
          id: item.id || 'g_' + Math.random().toString(36).substr(2,9),
          title: title + (v.subtitle ? ': ' + v.subtitle : ''),
          authors: v.authors || [],
          publisher: v.publisher || '',
          publication_date: pubDate || (year ? year+'-01-01' : '2024-01-01'),
          pages: v.pageCount || null,
          isbn: (isbn13 && isbn13.identifier) || (isbn10 && isbn10.identifier) || '',
          book_url: v.infoLink || v.previewLink || '',
          cover: ((v.imageLinks && v.imageLinks.thumbnail) || '').replace('http:', 'https:'),
          description: (v.description || '').substring(0, 500),
          language: lang,
          topics: detectTopics(title, v.description),
          source: 'Google Books',
          rating: v.averageRating || null,
          addedAt: Date.now()
        };

        books.push(book);
      } catch (itemErr) {
        log(`Google Books: Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù†ØµØ±: ${itemErr.message}`, 'error');
      }
    }

    activeSources.add('Google Books');
  } catch (e) {
    log(`Google Books: Ø®Ø·Ø£ Ø¹Ø§Ù… "${query}": ${e.message}`, 'error');
  }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Open Library API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchOpenLib(query) {
  const books = [];
  try {
    const params = new URLSearchParams({ q: query, limit: '30', sort: 'new' });
    const url = `https://openlibrary.org/search.json?${params}`;
    log(`Open Library: "${query}"`);

    const resp = await fetch(url);
    if (!resp.ok) {
      log(`Open Library: HTTP ${resp.status}`, 'error');
      return books;
    }

    const data = await resp.json();
    const docs = data.docs || [];
    log(`Open Library: "${query}" â†’ ${docs.length} Ù†ØªÙŠØ¬Ø©`, docs.length > 0 ? 'success' : 'warn');

    for (const doc of docs) {
      try {
        const title = doc.title || '';
        if (!title) continue;
        const year = doc.first_publish_year || 0;
        if (year > 0 && year < 2022) continue;

        const coverId = doc.cover_i;
        books.push({
          id: 'ol_' + (doc.key || Math.random().toString(36).substr(2,9)),
          title,
          authors: doc.author_name || [],
          publisher: (doc.publisher || [])[0] || '',
          publication_date: year ? year + '-01-01' : '2024-01-01',
          pages: doc.number_of_pages_median || null,
          isbn: (doc.isbn || [])[0] || '',
          book_url: 'https://openlibrary.org' + doc.key,
          cover: coverId ? `https://covers.openlibrary.org/b/id/${coverId}-M.jpg` : '',
          description: '',
          language: detectLang(title),
          topics: detectTopics(title, (doc.subject || []).join(' ')),
          source: 'Open Library',
          rating: null,
          addedAt: Date.now()
        });
      } catch (e) {}
    }
    activeSources.add('Open Library');
  } catch (e) {
    log(`Open Library: Ø®Ø·Ø£ "${query}": ${e.message}`, 'error');
  }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Crossref API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchCrossref(query) {
  const books = [];
  try {
    const params = new URLSearchParams({
      query: query,
      filter: 'type:book,from-pub-date:2022-01-01',
      rows: '20',
      sort: 'published',
      order: 'desc'
    });
    const url = `https://api.crossref.org/works?${params}`;
    log(`Crossref: "${query}"`);

    const resp = await fetch(url, {
      headers: { 'User-Agent': 'PalestineBooks/2.0 (mailto:research@example.com)' }
    });

    if (!resp.ok) {
      log(`Crossref: HTTP ${resp.status}`, 'error');
      return books;
    }

    const data = await resp.json();
    const items = (data.message && data.message.items) || [];
    log(`Crossref: "${query}" â†’ ${items.length} Ù†ØªÙŠØ¬Ø©`, items.length > 0 ? 'success' : 'warn');

    for (const item of items) {
      try {
        const title = (item.title || [])[0] || '';
        if (!title) continue;

        const dp = (item['published-print'] && item['published-print']['date-parts'] && item['published-print']['date-parts'][0]) ||
                   (item['published-online'] && item['published-online']['date-parts'] && item['published-online']['date-parts'][0]);
        const pubDate = dp ? `${dp[0]}-${String(dp[1]||1).padStart(2,'0')}-${String(dp[2]||1).padStart(2,'0')}` : '2024-01-01';

        books.push({
          id: 'cr_' + (item.DOI || Math.random().toString(36).substr(2,9)),
          title,
          authors: (item.author || []).map(a => `${a.given || ''} ${a.family || ''}`.trim()),
          publisher: item.publisher || '',
          publication_date: pubDate,
          pages: item.page ? parseInt(item.page) : null,
          isbn: (item.ISBN || [])[0] || '',
          book_url: item.URL || (item.DOI ? `https://doi.org/${item.DOI}` : ''),
          cover: '',
          description: '',
          language: detectLang(title),
          topics: detectTopics(title, (item.subject || []).join(' ')),
          source: 'Crossref',
          rating: null,
          addedAt: Date.now()
        });
      } catch (e) {}
    }
    activeSources.add('Crossref');
  } catch (e) {
    log(`Crossref: Ø®Ø·Ø£ "${query}": ${e.message}`, 'error');
  }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - ØªØ±Ø§ÙƒÙ…ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAllBooks() {
  if (isUpdating) {
    log('â³ ØªØ­Ø¯ÙŠØ« Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø§Ù„ÙØ¹Ù„...', 'warn');
    return;
  }
  isUpdating = true;
  activeSources.clear();

  const prevCount = ALL_BOOKS.length;

  document.getElementById('pbar').style.display = 'block';
  document.getElementById('rBtn').disabled = true;

  // â˜… Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙƒØªØ¨
  if (ALL_BOOKS.length === 0) {
    document.getElementById('grid').innerHTML =
      '<div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø±...</p></div>';
  }

  log('â•â•â•â•â•â•â• Ø¨Ø¯Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ â•â•â•â•â•â•â•', 'info');

  const newBooks = [];

  // â”€â”€ Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… â”€â”€
  const tasks = [];

  // Google Books - Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
  for (const q of QUERIES.en) {
    tasks.push({ api: 'google', q, lang: 'en' });
  }
  // Google Books - ÙØ±Ù†Ø³ÙŠ
  for (const q of QUERIES.fr) {
    tasks.push({ api: 'google', q, lang: 'fr' });
  }
  // Google Books - Ø¹Ø±Ø¨ÙŠ
  for (const q of QUERIES.ar) {
    tasks.push({ api: 'google', q, lang: 'ar' });
  }
  // Open Library
  for (const q of QUERIES.en.slice(0, 10)) {
    tasks.push({ api: 'openlib', q, lang: 'en' });
  }
  // Crossref
  for (const q of QUERIES.en.slice(0, 8)) {
    tasks.push({ api: 'crossref', q, lang: 'en' });
  }

  const total = tasks.length;
  let done = 0;

  for (const task of tasks) {
    done++;
    const pct = Math.round((done / total) * 100);
    document.getElementById('pfill').style.width = pct + '%';
    document.getElementById('ptxt').textContent = `â³ ${pct}% â€” ${task.api}: ${task.q.substring(0, 30)}...`;

    let result = [];
    try {
      if (task.api === 'google') {
        result = await fetchGoogle(task.q, task.lang);
      } else if (task.api === 'openlib') {
        result = await fetchOpenLib(task.q);
      } else if (task.api === 'crossref') {
        result = await fetchCrossref(task.q);
      }
    } catch (e) {
      log(`Ø®Ø·Ø£ ÙÙŠ ${task.api}: ${e.message}`, 'error');
    }

    if (result.length > 0) {
      newBooks.push(...result);
      log(`+${result.length} ÙƒØªØ§Ø¨ Ù…Ù† ${task.api} (${task.q.substring(0,25)})`, 'success');
    }

    // â˜… ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªØ¬Ù†Ø¨ Rate Limit
    const delay = task.api === 'google' ? 600 : task.api === 'crossref' ? 1200 : 500;
    await sleep(delay);
  }

  log(`â•â•â•â•â•â•â• Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¬Ù„Ø¨: ${newBooks.length} ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯ â•â•â•â•â•â•â•`);

  // â˜… Ø¯Ù…Ø¬ ØªØ±Ø§ÙƒÙ…ÙŠ
  const combined = [...ALL_BOOKS, ...newBooks];
  ALL_BOOKS = dedup(combined);

  // ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«
  ALL_BOOKS.sort((a, b) => new Date(b.publication_date) - new Date(a.publication_date));

  const addedCount = ALL_BOOKS.length - prevCount;
  log(`ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${prevCount} â†’ ${ALL_BOOKS.length} (Ø£ÙØ¶ÙŠÙ ${addedCount > 0 ? addedCount : 0})`, 'success');

  // Ø­ÙØ¸
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      books: ALL_BOOKS,
      timestamp: Date.now(),
      sources: [...activeSources]
    }));
    log('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage', 'success');
  } catch (e) {
    log('ğŸ’¾ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + e.message, 'error');
  }

  // Ø¥Ù†Ù‡Ø§Ø¡
  document.getElementById('pbar').style.display = 'none';
  document.getElementById('rBtn').disabled = false;
  isUpdating = false;

  updateStats();
  filterBooks();
  updateTime();

  if (addedCount > 0 && prevCount > 0) {
    showNotif(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${addedCount} ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯!`);
  }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function showNotif(msg) {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLang(lang, btn) {
  currentLang = lang;
  document.querySelectorAll('.fbtn').forEach(b => b.className = 'fbtn');
  if (lang === 'all') btn.classList.add('active');
  else btn.classList.add('a-' + lang);
  filterBooks();
}

function filterBooks() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const topic = document.getElementById('topicSel').value;
  const sort = document.getElementById('sortSel').value;

  let list = ALL_BOOKS.filter(b => {
    if (currentLang !== 'all' && b.language !== currentLang) return false;
    if (topic && !b.topics.some(t => t.toLowerCase().includes(topic.toLowerCase()))) return false;
    if (search) {
      const hay = (b.title + ' ' + b.authors.join(' ') + ' ' + b.publisher + ' ' + (b.description || '')).toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });

  if (sort === 'title') list.sort((a, b) => a.title.localeCompare(b.title, 'ar'));
  else list.sort((a, b) => new Date(b.publication_date) - new Date(a.publication_date));

  renderBooks(list);
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function renderBooks(books) {
  const grid = document.getElementById('grid');

  if (!books.length && ALL_BOOKS.length === 0) {
    grid.innerHTML = '<div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨...</p></div>';
    return;
  }

  if (!books.length) {
    grid.innerHTML = `<div class="no-res"><div class="emoji">ğŸ“š</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©</p><p style="font-size:.9em;margin-top:8px;opacity:.7">Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±</p></div>`;
    return;
  }

  const hotTopics = ['Nakba','Gaza','Genocide','Occupation','Resistance','Hamas'];

  grid.innerHTML = books.map(b => {
    const lc = `l-${b.language}`;
    const ll = b.language === 'ar' ? 'Ø¹Ø±Ø¨ÙŠ' : b.language === 'fr' ? 'FranÃ§ais' : 'English';
    const date = b.publication_date ? new Date(b.publication_date).toLocaleDateString('en-US', { year:'numeric', month:'short' }) : '';

    const coverHTML = b.cover
      ? `<img src="${b.cover}" alt="${esc(b.title)}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/150x200/1a1a1a/ffffff?text=ğŸ‡µğŸ‡¸'">`
      : `<div style="width:130px;height:180px;background:linear-gradient(135deg,#c8102e,#007a3d);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:4em">ğŸ‡µğŸ‡¸</div>`;

    const tagsHTML = b.topics.slice(0,5).map(t =>
      `<span class="tag ${hotTopics.some(h=>t.includes(h))?'hot':''}">${esc(t)}</span>`
    ).join('');

    return `
    <div class="book-card">
      <div class="cover-wrap">
        ${coverHTML}
        <span class="lang-badge ${lc}">${ll}</span>
        <span class="src-badge">${esc(b.source)}</span>
      </div>
      <div class="book-body" dir="rtl">
        <div class="book-title">${esc(b.title)}</div>
        <div class="book-author">âœ ${esc(b.authors.slice(0,3).join('ØŒ ') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</div>
        <div class="book-pub">ğŸ› ${esc(b.publisher || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</div>
        <div class="book-meta">
          ${date ? `<span>ğŸ“… ${date}</span>` : ''}
          ${b.pages ? `<span>ğŸ“„ ${b.pages} ØµÙØ­Ø©</span>` : ''}
          ${b.rating ? `<span>â­ ${b.rating.toFixed(1)}</span>` : ''}
          ${b.isbn ? `<span>ğŸ“‹ ISBN</span>` : ''}
        </div>
        <div class="topics">${tagsHTML}</div>
        ${b.description ? `<div class="book-desc">${esc(b.description)}</div>` : ''}
        <div class="book-actions">
          ${b.book_url ? `<a href="${esc(b.book_url)}" target="_blank" rel="noopener" class="blink bp">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨</a>` : ''}
          ${b.isbn ? `<a href="https://www.worldcat.org/isbn/${b.isbn}" target="_blank" rel="noopener" class="blink bs">ğŸ“š WorldCat</a>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  document.getElementById('sTotal').textContent = ALL_BOOKS.length;
  document.getElementById('sAr').textContent = ALL_BOOKS.filter(b => b.language === 'ar').length;
  document.getElementById('sEn').textContent = ALL_BOOKS.filter(b => b.language === 'en').length;
  document.getElementById('sFr').textContent = ALL_BOOKS.filter(b => b.language === 'fr').length;
  document.getElementById('sPub').textContent = new Set(ALL_BOOKS.map(b => b.publisher).filter(Boolean)).size;
  document.getElementById('sSrc').textContent = activeSources.size || '-';
}

function updateTime() {
  document.getElementById('lastUp').textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' +
    new Date().toLocaleString('ar-EG', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ÙˆÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function manualRefresh() {
  log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
  fetchAllBooks();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù…Ø±ØµØ¯ ÙƒØªØ¨ ÙÙ„Ø³Ø·ÙŠÙ† v6');

  // â˜… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (raw) {
      const cache = JSON.parse(raw);
      if (cache && cache.books && cache.books.length > 0) {
        ALL_BOOKS = cache.books;
        if (cache.sources) cache.sources.forEach(s => activeSources.add(s));

        updateStats();
        filterBooks();
        updateTime();

        log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${ALL_BOOKS.length} ÙƒØªØ§Ø¨ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©`, 'success');

        // Ø§Ù„ØªØ­Ù‚Ù‚: Ù‡Ù„ Ù…Ø± ÙŠÙˆÙ…ØŸ
        const elapsed = Date.now() - (cache.timestamp || 0);
        if (elapsed < DAILY_MS) {
          const hrs = Math.round((DAILY_MS - elapsed) / 3600000);
          log(`â° Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¯Ù… Ø¨Ø¹Ø¯ ~${hrs} Ø³Ø§Ø¹Ø©`);
          setTimeout(() => fetchAllBooks(), DAILY_MS - elapsed);
          return;
        }

        log('ğŸ”„ Ù…Ø± ÙŠÙˆÙ… ÙƒØ§Ù…Ù„ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ¨ Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©...');
        fetchAllBooks();
        return;
      }
    }
  } catch (e) {
    log('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©: ' + e.message, 'error');
  }

  // Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø­ÙÙˆØ¸Ø©
  log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„ØµÙØ±...');
  await fetchAllBooks();
})();

// ØªØ­Ø¯ÙŠØ« ÙŠÙˆÙ…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ
setInterval(() => {
  log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙŠÙˆÙ…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
  fetchAllBooks();
}, DAILY_MS);
</script>
</body>
</html>
